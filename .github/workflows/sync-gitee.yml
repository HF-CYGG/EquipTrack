name: Sync to Gitee

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Sync Releases to Gitee
        id: sync_releases
        uses: actions/github-script@v7
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
        with:
          script: |
            const owner = 'YeMiao_cats';
            const repo = 'EquipTrack';
            const fs = require('fs');
            const path = require('path');
            const manifestPath = path.join(process.env.RUNNER_TEMP || '/tmp', 'gitee-release-manifest.json');
            
            // 1. 获取 Gitee 现有 Releases
            async function getGiteeReleases() {
              const res = await fetch(`https://gitee.com/api/v5/repos/${owner}/${repo}/releases?access_token=${process.env.GITEE_TOKEN}&page=1&per_page=20`);
              if (!res.ok) return [];
              return await res.json();
            }

            // 2. 同步单个 Release
            async function syncRelease(release) {
              const { name, body, tag_name, prerelease, assets } = release;
              console.log(`Processing release: ${tag_name}`);

              const giteeReleases = await getGiteeReleases();
              let targetRelease = giteeReleases.find(r => r.tag_name === tag_name);
              let giteeId = targetRelease ? targetRelease.id : null;

              // 如果 Gitee 不存在该 Release，则创建
              if (!giteeId) {
                console.log(`Creating release ${tag_name} on Gitee...`);
                const createRes = await fetch(`https://gitee.com/api/v5/repos/${owner}/${repo}/releases`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json;charset=UTF-8' },
                  body: JSON.stringify({
                    access_token: process.env.GITEE_TOKEN,
                    tag_name, name, body, prerelease,
                    target_commitish: 'main'
                  })
                });
                if (createRes.ok) {
                  const data = await createRes.json();
                  giteeId = data.id;
                  console.log(`Created Gitee release ID: ${giteeId}`);
                } else {
                  console.error('Failed to create release on Gitee');
                  return null;
                }
              }

              // 准备需要上传的 Assets
              const existingAssets = targetRelease ? (targetRelease.assets || []) : [];
              const existingNames = new Set(existingAssets.map(a => a.name));
              
              const assetsToUpload = (assets || []).map(a => ({
                name: a.name,
                url: a.browser_download_url
              })).filter(a => !existingNames.has(a.name));

              return {
                tag_name,
                giteeId,
                assets: assetsToUpload
              };
            }

            // Main Logic
            try {
              let entries = [];
              if (context.eventName === 'release') {
                const entry = await syncRelease(context.payload.release);
                if (entry) entries.push(entry);
              } else if (context.eventName === 'workflow_dispatch') {
                const releases = await github.rest.repos.listReleases({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  per_page: 5
                });
                // 只同步最新的 5 个
                for (const rel of releases.data) {
                   const entry = await syncRelease(rel);
                   if (entry) entries.push(entry);
                }
              }
              
              fs.writeFileSync(manifestPath, JSON.stringify(entries, null, 2));
              core.setOutput('manifest_path', manifestPath);
            } catch (err) {
              core.setFailed(err.message);
            }

      - name: Sync Code to Gitee
        if: always()
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          git remote remove gitee 2>/dev/null || true
          git remote add gitee https://YeMiao_cats:${{ secrets.GITEE_TOKEN }}@gitee.com/YeMiao_cats/EquipTrack.git
          git fetch origin main
          git push gitee origin/main:main --force
          git push gitee --tags --force
