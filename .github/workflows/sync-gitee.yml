name: Sync to Gitee

on:
  release:
    types: [published]
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Push to Gitee
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # Add Gitee remote with Token authentication
          # Format: https://<username>:<token>@gitee.com/<owner>/<repo>.git
          git remote add gitee "https://YeMiao_cats:${{ secrets.GITEE_TOKEN }}@gitee.com/YeMiao_cats/EquipTrack.git"
          
          # Push main branch and tags
          # Using --force to ensure Gitee stays exactly in sync with GitHub
          git push gitee main --force
          git push gitee --tags --force

      - name: Sync Release to Gitee
        if: github.event_name == 'release'
        uses: actions/github-script@v7
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
        with:
          script: |
            const { name, body, tag_name, prerelease, assets } = context.payload.release;
            const owner = 'YeMiao_cats';
            const repo = 'EquipTrack';
            
            console.log(`Syncing release ${tag_name} to Gitee...`);
            
            // 1. Get or Create Release
            let giteeId = null;
            
            try {
              // Try creating
              const createRes = await fetch(`https://gitee.com/api/v5/repos/${owner}/${repo}/releases`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json;charset=UTF-8' },
                body: JSON.stringify({
                  access_token: process.env.GITEE_TOKEN,
                  tag_name, name, body, prerelease
                })
              });
              
              const createData = await createRes.json();
              
              if (createRes.ok) {
                console.log('✅ Created new release on Gitee:', createData.name);
                giteeId = createData.id;
              } else if (createData.message && (createData.message.includes('已存在') || createData.message.includes('exists'))) {
                 console.log('Release already exists, fetching ID...');
                 const getRes = await fetch(`https://gitee.com/api/v5/repos/${owner}/${repo}/releases/tags/${encodeURIComponent(tag_name)}?access_token=${process.env.GITEE_TOKEN}`);
                 if (getRes.ok) {
                    const getData = await getRes.json();
                    giteeId = getData.id;
                    console.log('✅ Found existing release ID:', giteeId);
                 } else {
                    throw new Error(`Failed to fetch existing release: ${getRes.statusText}`);
                 }
              } else {
                 throw new Error(`Failed to create release: ${JSON.stringify(createData)}`);
              }
              
              // 2. Upload Assets
              if (giteeId && assets && assets.length > 0) {
                console.log(`Found ${assets.length} assets to sync.`);
                
                for (const asset of assets) {
                  console.log(`Downloading ${asset.name} from GitHub...`);
                  const fileRes = await fetch(asset.browser_download_url);
                  if (!fileRes.ok) {
                     console.warn(`Failed to download ${asset.name}, skipping.`);
                     continue;
                  }
                  const blob = await fileRes.blob();
                  
                  console.log(`Uploading ${asset.name} to Gitee...`);
                  const formData = new FormData();
                  formData.append('access_token', process.env.GITEE_TOKEN);
                  formData.append('file', blob, asset.name);
                  
                  const uploadRes = await fetch(`https://gitee.com/api/v5/repos/${owner}/${repo}/releases/${giteeId}/attach_files`, {
                    method: 'POST',
                    body: formData
                  });
                  
                  if (uploadRes.ok) {
                     console.log(`✅ Uploaded ${asset.name}`);
                  } else {
                     const uploadData = await uploadRes.json();
                     console.warn(`⚠️ Failed to upload ${asset.name}:`, uploadData);
                  }
                }
              } else {
                 console.log('No assets to upload or Release ID missing.');
              }

            } catch (error) {
              core.setFailed(`Sync Error: ${error.message}`);
            }
